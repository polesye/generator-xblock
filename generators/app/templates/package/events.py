"""
Events mixin for the XBlock.
"""
from xblock.core import XBlock


class EventsMixin(object):
    """
    Adds events support.
    """
    def _get_unique_id(self):
        """
        Generates an unique id for the XBlock.
        """
        try:
            unique_id = self.location.name
        except AttributeError:
            # workaround for xblock workbench
            unique_id = self.parent.replace('.',  '-')
        return unique_id

    @XBlock.json_handler
    def publish_event(self, data, suffix=''):
        """
        Event handler for the XBlock.
        """
        try:
            event_type = data.pop('event_type')
        except KeyError as e:
            return {'result': 'error', 'message': 'Missing event_type in JSON data'}

        data['user_id'] = self.scope_ids.user_id
        data['component_id'] = self._get_unique_id()

        self.runtime.publish(self, event_type, data)
        return {'result': 'success'}
